#include <Wire.h>

#define APDS9151_ADDR  0x52  // I2C address of the APDS-9151
#define ENABLE_REG     0x80  // Register to enable the sensor
#define STATUS_REG     0x93  // Status register (checks if data is ready)
#define CDATA_REG      0x94  // Clear (ambient light) data register
#define RDATA_REG      0x96  // Red channel data register
#define GDATA_REG      0x98  // Green channel data register
#define BDATA_REG      0x9A  // Blue channel data register

void setup() {
    Serial.begin(115200);
    Wire.begin();  // Start I2C communication

    // Enable the APDS-9151 sensor
    writeRegister(ENABLE_REG, 0x03);  // Enable ALS (ambient light sensing)
    
    Serial.println("APDS-9151 Initialized.");
}

void loop() {
    if (readRegister(STATUS_REG) & 0x01) {  // Check if color data is ready
        uint16_t clear = read16(CDATA_REG);
        uint16_t red   = read16(RDATA_REG);
        uint16_t green = read16(GDATA_REG);
        uint16_t blue  = read16(BDATA_REG);

        Serial.print("Red: "); Serial.print(red);
        Serial.print(" Green: "); Serial.print(green);
        Serial.print(" Blue: "); Serial.print(blue);
        Serial.print(" Clear: "); Serial.println(clear);
    }
    
    delay(500);  // Wait before next reading
}

// Function to write a value to a register
void writeRegister(uint8_t reg, uint8_t value) {
    Wire.beginTransmission(APDS9151_ADDR);
    Wire.write(reg);
    Wire.write(value);
    Wire.endTransmission();
}

// Function to read a single-byte register
uint8_t readRegister(uint8_t reg) {
    Wire.beginTransmission(APDS9151_ADDR);
    Wire.write(reg);
    Wire.endTransmission(false);
    
    Wire.requestFrom(APDS9151_ADDR, 1);
    return Wire.available() ? Wire.read() : 0;
}

// Function to read a 16-bit register (2 bytes)
uint16_t read16(uint8_t reg) {
    Wire.beginTransmission(APDS9151_ADDR);
    Wire.write(reg);
    Wire.endTransmission(false);
    
    Wire.requestFrom(APDS9151_ADDR, 2);
    if (Wire.available() < 2) return 0;
    
    uint16_t data = Wire.read();
    data |= (Wire.read() << 8);  // Combine two bytes into 16-bit value
    return data;
}
